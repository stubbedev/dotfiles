#!/bin/bash

# aerc-whichkey.sh: Display aerc keybindings in fzf menu, whichkey-style

CONFIG_FILE="$HOME/.stubbe/src/aerc/binds.conf"
CONTEXT="messages"  # Default context; could be made dynamic if possible

# Parse binds.conf for the given context
parse_binds() {
    local in_context=false
    while IFS= read -r line; do
        # Check for context start
        if [[ $line =~ ^\[([^\]]+)\] ]]; then
            current_context="${BASH_REMATCH[1]}"
            if [[ $current_context == "$CONTEXT" ]]; then
                in_context=true
            else
                in_context=false
            fi
            continue
        fi

        # If in context and line is a bind
        if $in_context && [[ $line =~ ^([^=]+)=(.+) ]]; then
            key="${BASH_REMATCH[1]// /}"  # Remove spaces
            cmd="${BASH_REMATCH[2]}"
            # Look for comment on previous line
            if [[ $prev_line =~ ^#(.+) ]]; then
                desc="${BASH_REMATCH[1]// /}"  # Remove leading/trailing spaces
            else
                desc="No description"
            fi
            echo "$key : $desc"
        fi
        prev_line="$line"
    done < "$CONFIG_FILE"
}

# Display in fzf
parse_binds | fzf --prompt="Aerc Keybindings ($CONTEXT): " --height=50% --border
