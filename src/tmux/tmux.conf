# ==============================================
# Prefix Key Configuration
# ==============================================
unbind C-b
set -g prefix M-Space
bind M-Space send-prefix
bind r source-file ~/.tmux.conf \; display "Config reloaded"  # Reload config

# ==============================================
# Terminal & Color Configuration
# ==============================================
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",*256col*:Tc"
set -ga terminal-overrides '*:Ss=\E[%p1%d q:Se=\E[ q'
set-environment -g COLORTERM "truecolor"
set -as terminal-features ",*:RGB"
set -ag terminal-overrides ",xterm-256color:RGB"

# ==============================================
# Pane Navigation (Alt + Arrow Keys)
# ==============================================
bind -n M-Left select-pane -L                            # Focus pane left
bind -n M-Right select-pane -R                           # Focus pane right
bind -n M-Up select-pane -U                              # Focus pane up
bind -n M-Down select-pane -D                            # Focus pane down
bind -n M-W select-pane -t :.+                           # Focus next pane
bind -n M-w select-pane -t :.-                           # Focus previous pane

# ==============================================
# Pane Resizing
# ==============================================
bind -n M-S-Down resize-pane -D                          # Resize pane down
bind -n M-S-Up resize-pane -U                            # Resize pane up
bind -n M-S-Left resize-pane -L                          # Resize pane left
bind -n M-S-Right resize-pane -R                         # Resize pane right
bind -r -T prefix , resize-pane -L 20                    # Resize pane left (large)
bind -r -T prefix . resize-pane -R 20                    # Resize pane right (large)
bind -r -T prefix - resize-pane -D 7                     # Resize pane down (large)
bind -r -T prefix = resize-pane -U 7                     # Resize pane up (large)

# ==============================================
# Pane Management
# ==============================================
bind -n M-z resize-pane -Z                               # Toggle pane zoom
bind -n M-q kill-pane                                    # Kill current pane
bind -n M-x swap-pane -D                                 # Swap pane with next
bind -n M-| split-pane -h -c "#{pane_current_path}"      # Split horizontal (50%)
bind -n M-\\ split-pane -h -l '30%' -c "#{pane_current_path}"  # Split horizontal (30%)
bind -n M-- split-pane -v -c "#{pane_current_path}"      # Split vertical (50%)
bind -n M-_ split-pane -v -l '30%' -c "#{pane_current_path}"   # Split vertical (30%)
bind m choose-window 'if -F "#{e|>:#{pane_width},#{e|*:2,#{pane_height}}}" "join-pane -h -s %%" "join-pane -s %%"'  # Pull pane (smart split)
bind j choose-window 'if -F "#{e|>:#{pane_width},#{e|*:2,#{pane_height}}}" "join-pane -h -t %%" "join-pane -t %%"'  # Send pane (smart split)
bind ! break-pane                                        # Break pane to new window
bind Space select-pane -m                                # Mark current pane
bind S-Space if -F "#{e|>:#{pane_width},#{e|*:2,#{pane_height}}}" "join-pane -h" "join-pane"  # Join marked pane (smart split)

# ==============================================
# Window Navigation & Management
# ==============================================
bind -n M-1 select-window -t 1                           # Go to window 1
bind -n M-2 select-window -t 2                           # Go to window 2
bind -n M-3 select-window -t 3                           # Go to window 3
bind -n M-4 select-window -t 4                           # Go to window 4
bind -n M-5 select-window -t 5                           # Go to window 5
bind -n M-6 select-window -t 6                           # Go to window 6
bind -n M-7 select-window -t 7                           # Go to window 7
bind -n M-8 select-window -t 8                           # Go to window 8
bind -n M-9 select-window -t 9                           # Go to window 9
bind -n M-0 select-window -t 10                          # Go to window 10
bind -n M-n next-window                                  # Next window
bind -n M-L next-window                                  # Next window (vim-style)
bind -n M-b previous-window                              # Previous window
bind -n M-H previous-window                              # Previous window (vim-style)
bind -n M-e new-window -c "#{pane_current_path}"         # New window in current path
bind -n M-Q kill-window                                  # Kill current window
bind -n M-s choose-window                                # Window picker
bind -n M-c command-prompt -I "#W" "rename-window '%%'"  # Rename window

# ==============================================
# Session Management
# ==============================================
bind -n M-d detach-client                                # Detach from session
bind -n M-S choose-session                               # Session picker
bind -n M-N switch-client -n                             # Next session
bind -n M-B switch-client -p                             # Previous session

# ==============================================
# Layout Management
# ==============================================
bind -n M-t next-layout                                  # Next layout
bind -n M-T previous-layout                              # Previous layout

# ==============================================
# Copy Mode & Clipboard
# ==============================================
bind -n M-v copy-mode                                    # Enter copy mode
bind -n M-p paste-buffer                                 # Paste buffer
bind-key -T copy-mode-vi v send-keys -X begin-selection  # Begin selection (vi mode)

# ==============================================
# Custom Scripts & FZF Integration
# ==============================================
bind -n M-f run-shell "tmux neww fzf-tmux-project-picker"  # FZF project picker
bind -n M-D run-shell "tmux neww fzf-directory-picker"     # FZF directory picker
bind -n M-h run-shell "tmux neww tmux-opencode"            # Open tmux-opencode

# ==============================================
# Plugin Configuration
# ==============================================
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'stubbedev/tmux-stubbe'

# ==============================================
# General Settings
# ==============================================
set -g base-index 1                                      # Start window numbering at 1
setw -g pane-base-index 1                                # Start pane numbering at 1
set -g renumber-windows on                               # Renumber windows when one is closed
set -g focus-events on                                   # Enable focus events for Neovim
set -g detach-on-destroy on                              # Detach when session is destroyed
set -sg escape-time 50                                   # Reduce escape delay
set -g history-limit 1000000                             # Scrollback buffer size
set -g mouse off                                         # Disable mouse
setw -g mode-keys vi                                     # Vi mode for copy mode
set -g visual-activity off                               # Don't show activity message
set -g monitor-activity on                               # Monitor background window activity

# ==============================================
# Plugin Auto-Update (daily background check)
# ==============================================
run-shell -b 'bash -c "
  TPM_DIR=\"\$HOME/.tmux/plugins/tpm\"
  [ -d \"\$TPM_DIR\" ] || exit 0
  LAST_MOD=\$(stat -c %Y \"\$TPM_DIR\" 2>/dev/null || stat -f %m \"\$TPM_DIR\" 2>/dev/null)
  TIME_NOW=\$(date +%s)
  if [ \$((TIME_NOW - LAST_MOD)) -gt 86400 ]; then
    sleep 5
    \$TPM_DIR/bin/update_plugins all >/dev/null 2>&1
    touch \"\$TPM_DIR\"
  fi
"'

# ==============================================
# Plugin Manager (auto-install TPM and plugins)
# ==============================================
run-shell 'bash -c "
  TPM_DIR=\"\$HOME/.tmux/plugins/tpm\"
  if [ ! -d \"\$TPM_DIR\" ]; then
    git clone https://github.com/tmux-plugins/tpm \"\$TPM_DIR\" >/dev/null 2>&1
  fi
"'
run '~/.tmux/plugins/tpm/tpm'
run-shell -b '~/.tmux/plugins/tpm/bin/install_plugins >/dev/null 2>&1'
