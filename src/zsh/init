#!/usr/bin/env zsh
if [ -d "$HOME/.stubbe" ]; then
  touch "$HOME/.zsh_history"
  STBDIR="$HOME/.stubbe/src/zsh"
  STBZSHSOURCES=(
    "paths"
    "apaths"
    "sysfuncs"
    "manager"
    "funcs"
    "aliases"
    "secrets"
    "plugins"
    "settings"
  )
  # Source fpaths first to set fpath before compinit
  if [ -f "$STBDIR/fpaths" ]; then
    source "$STBDIR/fpaths"
  fi

  autoload -Uz compinit
  zcompdump="${ZDOTDIR:-$HOME}/.zcompdump"
  if [[ ! -f $zcompdump || $zcompdump -ot ~/.zshrc ]]; then
    compinit -C
  else
    compinit -C -d "$zcompdump"
  fi

  # Source remaining files (excluding fpaths which was already sourced)
  for SZP in "${STBZSHSOURCES[@]}"; do
    if [ -f "$STBDIR/$SZP" ]; then
      source "$STBDIR/$SZP"
    fi
  done
fi
