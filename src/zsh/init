#!/usr/bin/env zsh

# Clean up any zombie jobs from previous sessions
disown 2>/dev/null

if [ -d "$HOME/.stubbe" ]; then
  touch "$HOME/.zsh_history"
  STBDIR="$HOME/.stubbe/src/zsh"

  # Files to source BEFORE compinit (must define functions that have completions)
  STBZSHSOURCES_PRE=(
    "paths"
    "fpaths"
    "apaths"
    "sysfuncs"
    "manager"
    "funcs"
  )

  # Files to source AFTER compinit
  STBZSHSOURCES_POST=(
    "aliases"
    "secrets"
    "plugins"
    "env"
    "settings"
  )

  # Source files that define functions BEFORE compinit
  for SZP in "${STBZSHSOURCES_PRE[@]}"; do
    if [ -f "$STBDIR/$SZP" ]; then
      source "$STBDIR/$SZP"
    fi
  done

  autoload -Uz compinit
  zcompdump="${ZDOTDIR:-$HOME}/.zcompdump"
  if [[ -f $zcompdump ]]; then
    compinit -C -d "$zcompdump"
  fi

  # Source remaining files AFTER compinit
  for SZP in "${STBZSHSOURCES_POST[@]}"; do
    if [ -f "$STBDIR/$SZP" ]; then
      source "$STBDIR/$SZP"
    fi
  done
fi
